# This files contains rules that apply to all AEM publish instance vhosts for all tenants


#### General settings ####

# Do not allow RFC 2616 trace requests
TraceEnable Off

# Enable rewrite engine
RewriteEngine On


#### Enable AEM dispatcher module ####

<Location />
  <IfModule disp_apache2.c>
    ModMimeUsePathInfo On
    # enable dispatcher for ALL requests.
    SetHandler dispatcher-handler
  </IfModule>
</Location>


#### Content disposition header for downloads ####

<LocationMatch "^.*/dam/.*\.download_attachment\..*$">
  Header set Content-Disposition: attachment
</LocationMatch>


#### Cache-control, noindex for some non-html files ####

Header set Cache-Control "public, must-revalidate"
<FilesMatch ".*\.(css|js)$">
  Header set X-Robots-Tag "noindex"
</FilesMatch>
<FilesMatch ".*\.sitemap\.xml$">
  Header set X-Robots-Tag "noindex"
</FilesMatch>


#### Deny access to sensitive areas ####

<Location "/admin">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</Location>
<Location "/apps">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</Location>
<Location "/bin">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</Location>
<Location "/crx">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</Location>
<Location "/etc">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</Location>
<Location "/home">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</Location>
<Location "/libs">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</Location>
<Location "/system/console">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</Location>
<Location "/var">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</Location>

# Allow access to clientlibs
<Location "/etc/clientlibs">
  <IfVersion < 2.4>
    Allow from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all granted
  </IfVersion>
</Location>

# Allow access to clientlibs proxy servlet
<Location "/etc.clientlibs">
  <IfVersion < 2.4>
    Allow from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all granted
  </IfVersion>
</Location>

# Allow dispatcher flushing only from defined hosts
<Location "/dispatcher">
  <IfVersion < 2.4>
    Order Deny,Allow
    Deny from all
{{~#if dispatcher.allowFlushFrom}}
    Allow from {{dispatcher.allowFlushFrom}}
{{~/if}}
{{~#if dispatcher.allowFlushFromHost}}
    Allow from {{dispatcher.allowFlushFromHost}}
{{~/if}}
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
{{~#if dispatcher.allowFlushFrom}}
    Require ip {{dispatcher.allowFlushFrom}}
{{~/if}}
{{~#if dispatcher.allowFlushFromHost}}
    Require host {{dispatcher.allowFlushFromHost}}
{{~/if}}
  </IfVersion>
</Location>


#### Deny access to dangerous selectors ####

#match *.infinity.json
<LocationMatch "^/.*\.infinity\.json.*$">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</LocationMatch>

# match *.-1.json and similar
<LocationMatch "^/.*\.-[0-9]+\.json.*$">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</LocationMatch>

# match *.tidy.json
<LocationMatch "^/.*\.tidy\.json.*$">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</LocationMatch>

# match *.query.json
<LocationMatch "^/.*\.query\.json.*$">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</LocationMatch>

# match sysview.xml
<LocationMatch "^/.*\.sysview\.xml.*$">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</LocationMatch>

# match docview.json/xml
<LocationMatch "^/.*\.docview\.(json|xml).*$">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</LocationMatch>

# match feed/feedentry.*
<LocationMatch "^/.*\.feed(entry)?\.*.*$">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</LocationMatch>

# match form.*
<LocationMatch "^/.*\.form\.*.*$">
  <IfVersion < 2.4>
    Deny from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
  </IfVersion>
</LocationMatch>
